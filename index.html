<script>
    // --- DOM Elements ---
    const analyzeBtn = document.getElementById('analyzeBtn');
    const websiteUrlInput = document.getElementById('websiteUrl');
    const resultsSection = document.getElementById('results');
    const loader = document.getElementById('loader');
    const content = document.getElementById('content');
    const errorBox = document.getElementById('errorBox');
    const errorMessage = document.getElementById('errorMessage');
    const healthScoreText = document.getElementById('healthScoreText');
    const healthScoreCircle = document.getElementById('healthScoreCircle');
    const healthRecommendations = document.getElementById('healthRecommendations');
    const newHtmlCode = document.getElementById('newHtmlCode');

    // --- Sample Website Data (Simulation) ---
    const oldWebsiteHTML = `
        <div style="font-family: 'Times New Roman', serif; background-color: #FFFFCC; padding: 15px; border: 2px solid #000;">
            <h1 style="color: #0000FF; text-align: center;">Welcome to Dave's Digital Doodads!</h1>
            <p style="font-size: 14px; color: #333;">We are the PREMIER online shop for all your digital needs. Established in 1998, we have the best widgets and gizmos on the web.</p>
            <img src="https://placehold.co/400x80/0000FF/FFFFFF?text=Cool+Banner+Ad" alt="A promotional banner">
            <h2>Our Products</h2>
            <ul>
                <li>Super Widget 5000</li>
                <li>Mega Gizmo Plus</li>
                <li>Turbo Encabulator</li>
            </ul>
            <p>Contact us at: <a href="mailto:dave@example.com">dave@example.com</a></p>
            <button onclick="alert('Thanks for your interest!')">Click for a Surprise!</button>
        </div>
    `;

    // --- Gemini API Call Function ---
    async function callGemini(prompt, isJson = false) {
        const apiKey = ""; // Canvas will provide the key
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: isJson ? { responseMimeType: "application/json" } : {}
        };

        try {
            const response = await fetch(https://member-portal-backend-f1p2.onrender.com, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorBody?.error?.message || 'Unknown error'}`);
            }

            const result = await response.json();

            const part = result?.candidates?.[0]?.content?.parts?.[0];
            if (part?.text) {
                return part.text;
            } else {
                const blockReason = result?.promptFeedback?.blockReason;
                if (blockReason) {
                    throw new Error(`Request was blocked: ${blockReason}. Please adjust the prompt.`);
                }
                throw new Error("The AI model returned an empty or invalid response.");
            }
        } catch (error) {
            console.error("Gemini API call failed:", error);
            showError(error.message);
            throw error;
        }
    }

    // --- Main Logic ---
    analyzeBtn.addEventListener('click', async () => {
        if (!websiteUrlInput.value.trim()) {
            showError("Please enter a URL to begin the simulation.");
            websiteUrlInput.focus();
            return;
        }

        resultsSection.style.display = 'block';
        content.style.display = 'none';
        loader.style.display = 'flex';
        errorBox.style.display = 'none';

        try {
            const healthPrompt = `
                Analyze the following HTML code for website health. Focus on performance, modern accessibility (WCAG), and basic SEO.
                Provide a score from 0 to 100.
                Then, provide a brief summary and 3-5 key recommendations in markdown format.
                Do not suggest using a different framework. The output must be a valid JSON object with two keys: "score" (a number) and "recommendations" (a markdown string).

                HTML to analyze:
                \`\`\`html
                ${oldWebsiteHTML}
                \`\`\`
            `;
            const healthResponse = await callGemini(healthPrompt, true);
            const healthData = JSON.parse(healthResponse);
            displayHealthAnalysis(healthData.score, healthData.recommendations);

            const redesignPrompt = `
                You are an expert web designer. Redesign the following HTML code to give it a modern, professional, and fully responsive look.
                - Use Tailwind CSS classes directly in the HTML for all styling.
                - Do not use any inline 'style' attributes.
                - Use a clean, centered layout with a professional color palette (e.g., shades of gray, indigo, cyan).
                - Improve typography with a sans-serif font like Inter.
                - Make interactive elements like buttons and links look modern and engaging.
                - Ensure the image is responsive.
                - Replace the 'alert()' in the button with a simple 'console.log("Button clicked!")'.
                - Do not add, remove, or change the text content, list items, or links. Only focus on the design and structure.
                The output must be a valid JSON object with one key: "newHtml".

                Old HTML:
                \`\`\`html
                ${oldWebsiteHTML}
                \`\`\`
            `;
            const redesignResponse = await callGemini(redesignPrompt, true);
            const redesignData = JSON.parse(redesignResponse);
            displayRedesign(redesignData.newHtml);

            loader.style.display = 'none';
            content.style.display = 'block';

        } catch (error) {
            loader.style.display = 'none';
            resultsSection.style.display = 'block';
        }
    });

    // --- UI Display Functions ---
    function displayHealthAnalysis(score, recommendations) {
        let currentScore = 0;
        const interval = setInterval(() => {
            if (currentScore >= score) {
                clearInterval(interval);
                currentScore = score;
            }
            healthScoreText.textContent = currentScore;
            currentScore++;
        }, 15);

        const radius = healthScoreCircle.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (score / 100) * circumference;
        healthScoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
        healthScoreCircle.style.strokeDashoffset = circumference;
        setTimeout(() => {
            healthScoreCircle.style.strokeDashoffset = offset;
        }, 100);

        let strokeColor = '#22c55e';
        if (score < 50) strokeColor = '#ef4444';
        else if (score < 80) strokeColor = '#eab308';
        healthScoreCircle.style.stroke = strokeColor;
        
        healthRecommendations.innerHTML = marked.parse(recommendations);
    }

    function displayRedesign(html) {
        newHtmlCode.textContent = html;
    }
    
    function showError(message) {
        errorMessage.textContent = message;
        errorBox.style.display = 'block';
    }

    function copyCode(button, elementId) {
        const codeEl = document.getElementById(elementId);
        const textToCopy = codeEl.textContent;
        
        navigator.clipboard.writeText(textToCopy).then(() => {
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            button.classList.add('copied');
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('copied');
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy text: ', err);
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            } catch (err) {
                alert('Failed to copy code.');
            }
            document.body.removeChild(textArea);
        });
    }
</script>